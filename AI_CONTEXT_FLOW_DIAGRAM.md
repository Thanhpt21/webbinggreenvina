# ğŸ”„ AI Chat Context Flow Diagram

## High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ChatBox Component                         â”‚
â”‚  - Manages messages state                                   â”‚
â”‚  - Handles user input                                       â”‚
â”‚  - Displays messages                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ sendMessage(input)
                           â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Socket emit message  â”‚
                â”‚ to backend           â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ message confirmed
                           â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ AI Message Processing Triggered      â”‚
        â”‚ sendAiMessage(msg, convId, messages) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”œâ”€ Check: isAiProcessing?
                   â”œâ”€ Check: Admin shop loaded?
                   â”œâ”€ Check: Tokens available?
                   â”‚
                   â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ analyzeConversationContext(currentMessages)â”‚
        â”‚                                             â”‚
        â”‚ 1. Get last 10 user messages              â”‚
        â”‚ 2. Extract keywords from each message     â”‚
        â”‚ 3. Find related products for keywords     â”‚
        â”‚ 4. Determine conversation topic           â”‚
        â”‚                                             â”‚
        â”‚ Returns: MessageContext {                 â”‚
        â”‚   recentMessages: ChatMessage[]           â”‚
        â”‚   extractedKeywords: string[]             â”‚
        â”‚   relatedProducts: Product[]              â”‚
        â”‚   conversationTopic: string               â”‚
        â”‚ }                                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ buildProductContextString(products)     â”‚
        â”‚                                          â”‚
        â”‚ Converts products to readable format:   â”‚
        â”‚ "ğŸ“¦ Sáº£n pháº©m liÃªn quan:                 â”‚
        â”‚  1. TÃªn sáº£n pháº©m - GiÃ¡ - MÃ´ táº£"        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ callAiApi(msg, messageContext)          â”‚
        â”‚                                          â”‚
        â”‚ Builds enhanced system prompt:          â”‚
        â”‚ - Original system prompt                â”‚
        â”‚ - Add conversation topic                â”‚
        â”‚ - Add product context                   â”‚
        â”‚ - Add AI instructions about products    â”‚
        â”‚                                          â”‚
        â”‚ Sends to: POST /chat                    â”‚
        â”‚ Payload: {                              â”‚
        â”‚   prompt: string (user message)         â”‚
        â”‚   metadata: {                           â”‚
        â”‚     system: enhanced_prompt             â”‚
        â”‚     conversationTopic: string           â”‚
        â”‚     productCount: number                â”‚
        â”‚     max_tokens: 200                     â”‚
        â”‚     temperature: 0.2                    â”‚
        â”‚   }                                      â”‚
        â”‚ }                                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ AI API Response                         â”‚
        â”‚                                          â”‚
        â”‚ Returns: {                              â”‚
        â”‚   response: { text: string }            â”‚
        â”‚   usage: { total_tokens: number }       â”‚
        â”‚   cached: boolean                       â”‚
        â”‚ }                                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”œâ”€ Token deduction (if not cached)
                     â”‚
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Update Message State                    â”‚
        â”‚ Replace pending "..." with AI response  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Save to Database (if logged in)        â”‚
        â”‚ saveBotMessage.mutate({                 â”‚
        â”‚   conversationId, message, sessionId    â”‚
        â”‚ })                                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Display in Chat UI                      â”‚
        â”‚ Scroll to bottom, show message          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Message Analysis Deep Dive

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Conversation Messages                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ User: "Báº¡n cÃ³ Ã¡o thun nÃ o khÃ´ng?"                 â”‚
â”‚ AI: "CÃ³, chÃºng tÃ´i cÃ³ nhiá»u máº«u Ã¡o thun..."       â”‚
â”‚ User: "GiÃ y kÃ¨m theo cÃ³ khÃ´ng?"                   â”‚
â”‚ AI: "GiÃ y bÃ¡n riÃªng, cÃ³ size 36-46"               â”‚
â”‚ User: "Ão kÃ­ch thÆ°á»›c L, giÃ y size 42"             â”‚
â”‚ AI: "ÄÃ£ cÃ³ háº¿t trong kho..."                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“ extractProductKeywords()
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Keywords Extracted:            â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ - Ã¡o                          â”‚
    â”‚ - Ã¡o thun                     â”‚
    â”‚ - giÃ y                        â”‚
    â”‚ - size                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“ findProductsByKeyword()
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Related Products Found:                       â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 1. Ão Thun Nam CÆ¡ Báº£n (ID: 1)                â”‚
    â”‚    - GiÃ¡: 199,000Ä‘                          â”‚
    â”‚    - Sizes: XS-3XL                          â”‚
    â”‚                                              â”‚
    â”‚ 2. Ão Thun Ná»¯ Premium (ID: 2)               â”‚
    â”‚    - GiÃ¡: 249,000Ä‘                          â”‚
    â”‚    - Sizes: XS-2XL                          â”‚
    â”‚                                              â”‚
    â”‚ 3. GiÃ y Sneaker Nam Tráº¯ng (ID: 45)          â”‚
    â”‚    - GiÃ¡: 899,000Ä‘                          â”‚
    â”‚    - Sizes: 36-47                           â”‚
    â”‚                                              â”‚
    â”‚ 4. GiÃ y Thá»ƒ Thao Ná»¯ Há»“ng (ID: 46)           â”‚
    â”‚    - GiÃ¡: 799,000Ä‘                          â”‚
    â”‚    - Sizes: 35-42                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“ Determine Topic
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Conversation Topic: Ã¡o, giÃ y  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Product Context String Example

```
Original Message:
"Báº¡n cÃ²n Ã¡o size L, giÃ y size 42 khÃ´ng?"

After Analysis:
keywords: ['Ã¡o', 'giÃ y', 'size', 'L', '42']
products: [
  { id: 1, name: 'Ão Thun Nam', basePrice: 199000 },
  { id: 2, name: 'Ão Thun Ná»¯', basePrice: 249000 },
  { id: 45, name: 'GiÃ y Sneaker Nam', basePrice: 899000 },
  ...
]

Generated Context String:
"
ğŸ“¦ Sáº£n pháº©m liÃªn quan Ä‘Æ°á»£c tÃ¬m tháº¥y trong cuá»™c há»™i thoáº¡i:
1. Ão Thun Nam CÆ¡ Báº£n - GiÃ¡: 199,000Ä‘ - MÃ´ táº£: Ão thun nam cháº¥t liá»‡u cotton 100%...
2. Ão Thun Ná»¯ Premium - GiÃ¡: 249,000Ä‘ - MÃ´ táº£: Ão thun ná»¯ cao cáº¥p, thoÃ¡ng mÃ¡t...
3. GiÃ y Sneaker Nam Tráº¯ng - GiÃ¡: 899,000Ä‘ - MÃ´ táº£: GiÃ y sneaker nam kiá»ƒu dÃ¡ng hiá»‡n Ä‘áº¡i...
4. GiÃ y Thá»ƒ Thao Ná»¯ Há»“ng - GiÃ¡: 799,000Ä‘ - MÃ´ táº£: GiÃ y thá»ƒ thao ná»¯ nháº¹, Ãªm chÃ¢n...
5. Vá»› Cotton Nam - GiÃ¡: 49,000Ä‘ - MÃ´ táº£: Vá»› cotton cao cáº¥p, thoÃ¡ng khÃ­...
"

Enhanced System Prompt:
"
Báº¡n lÃ  trá»£ lÃ½ bÃ¡n hÃ ng thÃ´ng minh. Tráº£ lá»i ngáº¯n gá»n, há»¯u Ã­ch.

ğŸ“Œ Cuá»™c há»™i thoáº¡i hiá»‡n Ä‘ang nÃ³i vá»: Ã¡o, giÃ y

ğŸ“¦ Sáº£n pháº©m liÃªn quan Ä‘Æ°á»£c tÃ¬m tháº¥y trong cuá»™c há»™i thoáº¡i:
1. Ão Thun Nam CÆ¡ Báº£n - GiÃ¡: 199,000Ä‘ - MÃ´ táº£: Ão thun nam cháº¥t liá»‡u cotton 100%...
2. Ão Thun Ná»¯ Premium - GiÃ¡: 249,000Ä‘ - MÃ´ táº£: Ão thun ná»¯ cao cáº¥p, thoÃ¡ng mÃ¡t...
3. GiÃ y Sneaker Nam Tráº¯ng - GiÃ¡: 899,000Ä‘ - MÃ´ táº£: GiÃ y sneaker nam kiá»ƒu dÃ¡ng hiá»‡n Ä‘áº¡i...
4. GiÃ y Thá»ƒ Thao Ná»¯ Há»“ng - GiÃ¡: 799,000Ä‘ - MÃ´ táº£: GiÃ y thá»ƒ thao ná»¯ nháº¹, Ãªm chÃ¢n...
5. Vá»› Cotton Nam - GiÃ¡: 49,000Ä‘ - MÃ´ táº£: Vá»› cotton cao cáº¥p, thoÃ¡ng khÃ­...

ğŸ’¡ HÃ£y sá»­ dá»¥ng thÃ´ng tin sáº£n pháº©m trÃªn Ä‘á»ƒ tráº£ lá»i cÃ¢u há»i chi tiáº¿t hÆ¡n vá»: Ã¡o, giÃ y
Tham kháº£o thÃ´ng tin sáº£n pháº©m náº¿u cÃ³ liÃªn quan, nhÆ°ng Ä‘á»«ng buá»™c thÃªm sáº£n pháº©m náº¿u khÃ´ng cáº§n thiáº¿t.
"
```

## Token Flow with Context

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Check Tokens Available    â”‚
â”‚    tokenAI = 500             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Send to AI with Context   â”‚
â”‚    (Payload includes full    â”‚
â”‚     product context string)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. AI Processes & Responds   â”‚
â”‚    usage.total_tokens = 45   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Deduct Actual Tokens Used â”‚
â”‚    500 - 45 = 455            â”‚
â”‚    (Update in database)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Save Message & Response   â”‚
â”‚    Store in chat_messages    â”‚
â”‚    table                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Visual Created**: December 4, 2025
